<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>地图数据可视化</title>

    <link rel="stylesheet" href="./css/index.css">
    <link rel="stylesheet" href="./fonts/icomoon.css">
</head>

<body>
    <div class="viewport">
        <div class="column">
            <div class="overview panel">
                <div class="inner">
                    <div class="item">
                        <h4>2,190</h4>
                        <span>
                            <i class="icon-dot" style="color: #006cff"></i>
                            设备总数
                        </span>
                    </div>
                    <div class="item">
                        <h4>190</h4>
                        <span>
                            <i class="icon-dot" style="color: #6acca3"></i>
                            季度新增
                        </span>
                    </div>
                    <div class="item">
                        <h4>3,001</h4>
                        <span>
                            <i class="icon-dot" style="color: #6acca3"></i>
                            运营设备
                        </span>
                    </div>
                    <div class="item">
                        <h4>108</h4>
                        <span>
                            <i class="icon-dot" style="color: #ed3f35"></i>
                            异常设备
                        </span>
                    </div>
                </div>
            </div>
            <!--监控-->
            <div class="monitor panel">
                <div class="inner">
                    <div class="tabs">
                        <a href="javascript:;" data-index="0" class="active">故障设备监控</a>
                        <a href="javascript:;" data-index="1">异常设备监控</a>
                    </div>
                    <div class="content" style="display: block;">
                        <div class="head">
                            <span class="col">故障时间</span>
                            <span class="col">设备地址</span>
                            <span class="col">异常代码</span>
                        </div>
                        <div class="marquee-view">
                            <div class="marquee">
                                <div class="row">
                                    <span class="col">20180701</span>
                                    <span class="col">11北京市昌平西路金燕龙写字楼</span>
                                    <span class="col">1000001</span>
                                    <span class="icon-dot"></span>
                                </div>
                                <div class="row">
                                    <span class="col">20190601</span>
                                    <span class="col">北京市昌平区城西路金燕龙写字楼</span>
                                    <span class="col">1000002</span>
                                    <span class="icon-dot"></span>
                                </div>
                                <div class="row">
                                    <span class="col">20190704</span>
                                    <span class="col">北京市昌平区建材城西路金燕龙写字楼</span>
                                    <span class="col">1000003</span>
                                    <span class="icon-dot"></span>
                                </div>
                                <div class="row">
                                    <span class="col">20180701</span>
                                    <span class="col">北京市昌平区建路金燕龙写字楼</span>
                                    <span class="col">1000004</span>
                                    <span class="icon-dot"></span>
                                </div>
                                <div class="row">
                                    <span class="col">20190701</span>
                                    <span class="col">更多模板关注公众号【DreamCoders】</span>
                                    <span class="col">1000005</span>
                                    <span class="icon-dot"></span>
                                </div>
                                <div class="row">
                                    <span class="col">20190701</span>
                                    <span class="col">北京市昌平区建材城西路金燕龙写字楼</span>
                                    <span class="col">1000006</span>
                                    <span class="icon-dot"></span>
                                </div>
                                <div class="row">
                                    <span class="col">20190701</span>
                                    <span class="col">北京市昌平区建西路金燕龙写字楼</span>
                                    <span class="col">1000007</span>
                                    <span class="icon-dot"></span>
                                </div>
                                <div class="row">
                                    <span class="col">20190701</span>
                                    <span class="col">北京市昌平区建材城西路金燕龙写字楼</span>
                                    <span class="col">1000008</span>
                                    <span class="icon-dot"></span>
                                </div>
                                <div class="row">
                                    <span class="col">20190701</span>
                                    <span class="col">北京市昌平区建材城西路金燕龙写字楼</span>
                                    <span class="col">1000009</span>
                                    <span class="icon-dot"></span>
                                </div>
                                <div class="row">
                                    <span class="col">20190710</span>
                                    <span class="col">北京市昌平区建材城西路金燕龙写字楼</span>
                                    <span class="col">1000010</span>
                                    <span class="icon-dot"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="content">
                        <div class="head">
                            <span class="col">异常时间</span>
                            <span class="col">设备地址</span>
                            <span class="col">异常代码</span>
                        </div>
                        <div class="marquee-view">
                            <div class="marquee">
                                <div class="row">
                                    <span class="col">20190701</span>
                                    <span class="col">北京市昌平区建材城西路金燕龙写字楼</span>
                                    <span class="col">1000001</span>
                                    <span class="icon-dot"></span>
                                </div>
                                <div class="row">
                                    <span class="col">20190701</span>
                                    <span class="col">北京市昌平区建材城西路金燕龙写字楼</span>
                                    <span class="col">1000002</span>
                                    <span class="icon-dot"></span>
                                </div>
                                <div class="row">
                                    <span class="col">20190703</span>
                                    <span class="col">北京市昌平区建材城西路金燕龙写字楼</span>
                                    <span class="col">1000002</span>
                                    <span class="icon-dot"></span>
                                </div>
                                <div class="row">
                                    <span class="col">20190704</span>
                                    <span class="col">北京市昌平区建材城西路金燕龙写字楼</span>
                                    <span class="col">1000002</span>
                                    <span class="icon-dot"></span>
                                </div>
                                <div class="row">
                                    <span class="col">20190705</span>
                                    <span class="col">北京市昌平区建材城西路金燕龙写字楼</span>
                                    <span class="col">1000002</span>
                                    <span class="icon-dot"></span>
                                </div>
                                <div class="row">
                                    <span class="col">20190706</span>
                                    <span class="col">北京市昌平区建材城西路金燕龙写字楼</span>
                                    <span class="col">1000002</span>
                                    <span class="icon-dot"></span>
                                </div>
                                <div class="row">
                                    <span class="col">20190707</span>
                                    <span class="col">更多模板关注公众号【DreamCoders】</span>
                                    <span class="col">1000002</span>
                                    <span class="icon-dot"></span>
                                </div>
                                <div class="row">
                                    <span class="col">20190708</span>
                                    <span class="col">北京市昌平区建材城西路金燕龙写字楼</span>
                                    <span class="col">1000002</span>
                                    <span class="icon-dot"></span>
                                </div>
                                <div class="row">
                                    <span class="col">20190709</span>
                                    <span class="col">北京市昌平区建材城西路金燕龙写字楼</span>
                                    <span class="col">1000002</span>
                                    <span class="icon-dot"></span>
                                </div>
                                <div class="row">
                                    <span class="col">20190710</span>
                                    <span class="col">北京市昌平区建材城西路金燕龙写字楼</span>
                                    <span class="col">1000002</span>
                                    <span class="icon-dot"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--点位-->
            <div class="point panel">
                <div class="inner">
                    <h3>点位分布统计</h3>
                    <div class="chart">
                        <div class="pie"></div>
                        <div class="data">
                            <div class="item">
                                <h4>320,11</h4>
                                <span>
                                    <i class="icon-dot" style="color: #ed3f35"></i>
                                    点位总数
                                </span>
                            </div>
                            <div class="item">
                                <h4>418</h4>
                                <span>
                                    <i class="icon-dot" style="color: #eacf19"></i>
                                    本月新增
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="column">
            <!-- 地图 -->
            <div class="map">
                <h3>
                    <span class="icon-cube"></span>
                    医联体交互热力图
                </h3>
                <div class="chart">
                    <div class="geo"></div>
                </div>

            <!-- 添加按钮 -->
            <div class="button-container">
                <button id="btn-total-intensity" class="btn">总强度</button>
                <button id="btn-cooperation" class="btn">合作</button>
                <button id="btn-communication" class="btn">沟通</button>
                <button id="btn-technology" class="btn">技术</button>
            </div>
            </div>

            <!-- 用户 -->
            <div class="users panel">
                <div class="inner">
                    <h3>全国用户总量统计</h3>
                    <div class="chart">
                        <div class="bar"></div>
                        <div class="data">
                            <div class="item">
                                <h4>1,120,899</h4>
                                <span>
                                    <i class="icon-dot" style="color: #ed3f35"></i>
                                    交互总次数
                                </span>
                            </div>
                            <div class="item">
                                <h4>229</h4>
                                <span>
                                    <i class="icon-dot" style="color: #eacf19"></i>
                                    医院总数
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="column">
            <div class="order panel">
                <div class="inner">
                    <!-- 筛选 -->
                    <div class="filter">
                        <a data-key="day365" class="active">功能切换</a>
                    </div>
                    
                    <!-- 按钮区域 -->
                    <div class="button-container1">
                        <div class="button-row1">
                            <button id="btn-fushefanwei" class="custom-btn1">辐射范围</button>
                            <button id="btn-fushenengli" class="custom-btn1">辐射能力</button>
                            <button id="btn-jiaohuqiangdu" class="custom-btn1">交互强度</button>
                        </div>
                        <div class="button-row1">
                            <button id="btn-jiaohurelitu" class="custom-btn1">交互强度热力图</button>
                            <button id="btn-shuliangrelitu" class="custom-btn1">医联体数量散点/热力图</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 销售额 -->
            <div class="sales panel">
                <div class="inner">
                    <div class="caption">
                        <h3>医联体选择（可多选）</h3>
                        <!-- <a href="javascript:;" class="active" data-type="year">年</a>
                        <a href="javascript:;" data-type="quarter">季</a>
                        <a href="javascript:;" data-type="month">月</a>
                        <a href="javascript:;" data-type="week">周</a> -->
                    </div>
                    <!-- <div class="chart">
                        <div class="label">单位:万</div>
                        <div class="line"></div>
                    </div> -->
                    <div class="checkboxes">
                        <div class="left-column">
                            <label><input type="checkbox" name="hospital" value="wuhan_people">武汉大学人民医院</label>
                            <label><input type="checkbox" name="hospital" value="wuhan_zn">武汉大学中南医院</label>
                            <label><input type="checkbox" name="hospital" value="wuhan_dental">武汉大学口腔医院</label>
                        </div>
                        <div class="right-column">
                            <label><input type="checkbox" name="hospital" value="tongji">同济医院</label>
                            <label><input type="checkbox" name="hospital" value="xiehe">协和医院</label>
                            <label><input type="checkbox" name="hospital" value="hubei_tcm">湖北省中医院</label>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 渠道 季度 -->
            <div class="wrap">
                <div class="channel panel">
                    <div class="inner">
                        <h3>渠道分布</h3>
                        <div class="data">
                            <div class="item">
                                <h4>39 <small>%</small></h4>
                                <span>
                                    <i class="icon-plane"></i>
                                    机场
                                </span>
                            </div>
                            <div class="item">
                                <h4>28 <small>%</small></h4>
                                <span>
                                    <i class="icon-bag"></i>
                                    商场
                                </span>
                            </div>
                        </div>
                        <div class="data">
                            <div class="item">
                                <h4>20 <small>%</small></h4>
                                <span>
                                    <i class="icon-train"></i>
                                    地铁
                                </span>
                            </div>
                            <div class="item">
                                <h4>13 <small>%</small></h4>
                                <span>
                                    <i class="icon-bus"></i>
                                    火车站
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="quarter panel">
                    <div class="inner">
                        <h3>一季度销售进度</h3>
                        <div class="chart">
                            <div class="box">
                                <div class="gauge"></div>
                                <div class="label">75<small> %</small></div>
                            </div>
                            <div class="data">
                                <div class="item">
                                    <h4>1,321</h4>
                                    <span>
                                        <i class="icon-dot" style="color: #6acca3"></i>
                                        销售额(万元)
                                    </span>
                                </div>
                                <div class="item">
                                    <h4>150%</h4>
                                    <span>
                                        <i class="icon-dot" style="color: #ed3f35"></i>
                                        同比增长
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 排行榜 -->
            <div class="top panel">
                <div class="inner">
                    <div class="all">
                        <h3>全国热榜</h3>
                        <ul>
                            <li>
                                <i class="icon-cup1" style="color: #d93f36;"></i>
                                可爱多
                            </li>
                            <li>
                                <i class="icon-cup2" style="color: #68d8fe;"></i>
                                娃哈啥
                            </li>
                            <li>
                                <i class="icon-cup3" style="color: #4c9bfd;"></i>
                                喜之郎
                            </li>
                        </ul>
                    </div>
                    <div class="province">
                        <h3>各省热销 <i class="date">// 近30日 //</i></h3>
                        <div class="data">
                            <ul class="sup">
                                <li>
                                    <span>北京</span>
                                    <span>25,179 <s class="icon-up"></s></span>
                                </li>
                                <li>
                                    <span>河北</span>
                                    <span>23,252 <s class="icon-down"></s></span>
                                </li>
                                <li>
                                    <span>上海</span>
                                    <span>20,760 <s class="icon-up"></s></span>
                                </li>
                                <li>
                                    <span>江苏</span>
                                    <span>23,252 <s class="icon-down"></s></span>
                                </li>
                                <li>
                                    <span>山东</span>
                                    <span>20,760 <s class="icon-up"></s></span>
                                </li>
                            </ul>
                            <ul class="sub">
                                <!-- <li><span>数据</span><span> 数据<s class="icon-up"></s></span></li> -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script src="./js/jquery.min.js"></script>
<script src="./js/echarts.min.js"></script>
<script src="./js/index.js"></script>

<script src="./js/china.js"></script>
<script src="./js/mymap.js"></script>
<!-- <script src="./js/mymap1.js"></script> -->

<script>
    // 全局变量
    var data = [];
    var geoCoordMap = {};
    var currentInteractionType = '文章数量'; // 初始交互类型为文章数量
    // var function_type = '数量热力图';
    // 函数：更新选中的医院
    function updateSelectedHospitals_jiaohu() {
        // 获取所有被选中的复选框
        var checkboxes = document.querySelectorAll('input[name="hospital"]:checked');
        var selectedHospitals = [];
        
        // 获取所有选中的医院的值
        checkboxes.forEach(function(checkbox) {
            selectedHospitals.push(checkbox.value);
        });

        if (selectedHospitals.length === 0) {
            data = [];
            geoCoordMap = {};
            myecharts.setOption(option1, true); // 更新地图

            console.log('Updated data:', data);
            console.log('Updated geoCoordMap:', geoCoordMap);
        }
        else
        {
            // 将选中的医院传递到后端
            fetch('http://localhost:5500/get_hospital_count?hospitals=' + encodeURIComponent(selectedHospitals.join(',')))
            .then(response => response.json())
            .then(hospitalData  => {
                console.log('Selected hospital data:', data);
                
                // 清空之前的数据
                data = [];
                geoCoordMap = {};

                hospitalData.forEach(item => {
                    const hospitalName = item['医院'] || item['医院名称'];
                    if (hospitalName) {
                        // 根据当前的交互类型更新 data 的 value
                        var value = item[currentInteractionType] || 0;
                        data.push({
                            name: hospitalName,
                            value: Math.log(value) // 对数缩放
                        });
            
                        // 更新 geoCoordMap
                        geoCoordMap[hospitalName] = [parseFloat(item['经度']), parseFloat(item['纬度'])];
                    }
                });

                var newConvertedData = convertData(data);

                // 更新地图数据
                option.baseOption.series[0].data = newConvertedData;
                myecharts.setOption(option, true); // 更新地图

                console.log('Updated data:', data);
                console.log('Updated geoCoordMap:', geoCoordMap);
            })
            .catch(error => console.error('Error:', error));
        }
        
        
    }
    
    // 预处理城市数据函数
    function processCityNames(data) {
        return data.map(city => {
            if (city === "恩施土家族苗族自治州") {
                return "恩施"; // 特殊处理恩施土家族苗族自治州
            } else if (city.endsWith("市")) {
                return city.slice(0, -1); // 去掉以“市”结尾的城市名称
            } else {
                return city; // 其他城市名称保持不变
            }
        });
    }

    function updateSelectedHospitals_shuliang() {
        // Get all selected checkboxes
        var checkboxes = document.querySelectorAll('input[name="hospital"]:checked');
        var selectedHospitals = [];
        
        // Get the values of all selected hospitals
        checkboxes.forEach(function(checkbox) {
            selectedHospitals.push(checkbox.value);
        });
        
        if (selectedHospitals.length === 0) {
            data = [];
            geoCoordMap = {};
            myecharts.setOption(option1, true); // 更新地图
            option_bar.xAxis[0].data = []; // Update the x-axis with top 10 city names
            option_bar.series[0].data = []; // Update the series with corresponding city values

            var myechart1 = echarts.init($('.users .bar')[0]);
            myechart1.setOption(option_bar);

            console.log('Updated data:', data);
            console.log('Updated geoCoordMap:', geoCoordMap);
        }

        else
        {
            // Send selected hospitals to the backend
            fetch('http://localhost:5500/total_hospital_number?hospitals=' + encodeURIComponent(selectedHospitals.join(',')))
            .then(response => response.json())
            .then(cityData => {
                console.log('City data:', cityData);
                // Sort the city data by value (user count) in descending order and get the top 10
                var top10Cities = cityData.sort(function(a, b) {
                    return b.value - a.value;
                }).slice(0, 10);

                // Extract city names and values for the bar chart
                var cityNames = top10Cities.map(item => item.name);
                var cityValues = top10Cities.map(item => item.value);

                cityNames_new=processCityNames(cityNames)
                // Update the bar chart data
                option_bar.xAxis[0].data = cityNames_new; // Update the x-axis with top 10 city names
                option_bar.series[0].data = cityValues; // Update the series with corresponding city values

                var myechart1 = echarts.init($('.users .bar')[0]);
                myechart1.setOption(option_bar);


                // Clear previous data
                data = [];
                
                cityData.forEach(item => {
                    console.log(item)
                    var cityName = item['name'];
                    var count = item['value'];
                    // Check if city exists in geoCoordMap
                    geoCoordMap =geoCoordMap_china
                    if (geoCoordMap[cityName]) {
                        data.push({
                            name: cityName,
                            value: count
                        });
                    } else {
                        console.warn('City not found in geoCoordMap_china:', cityName);
                    }
                });

                var newConvertedData = convertData(data);


                console.log('Updated data:', data);
                // Update the map data
                option2.baseOption.series[0].data = newConvertedData;
                option2.baseOption.series[1].data = newConvertedData;
                myecharts.setOption(option2, true); // Update the map

                
            })
            .catch(error => console.error('Error:', error));
        }
        
    }
    


    
let function_type = ''; // Ensure this is defined globally

// 添加按钮点击事件
function setupButtonListeners() {
    document.getElementById('btn-fushefanwei').addEventListener('click', function() {
        function_type = '辐射范围';
        myecharts.setOption(option1, true); // 更新地图
        option_bar.xAxis[0].data = []; // Update the x-axis with top 10 city names
        option_bar.series[0].data = []; // Update the series with corresponding city values

        var myechart1 = echarts.init($('.users .bar')[0]);
        myechart1.setOption(option_bar);

        document.querySelector('.button-container').style.visibility = 'hidden';
        console.log('Function Type:', function_type); // Debugging line
    });

    document.getElementById('btn-fushenengli').addEventListener('click', function() {
        function_type = '辐射能力';
        myecharts.setOption(option1, true); // 更新地图
        option_bar.xAxis[0].data = []; // Update the x-axis with top 10 city names
        option_bar.series[0].data = []; // Update the series with corresponding city values

        var myechart1 = echarts.init($('.users .bar')[0]);
        myechart1.setOption(option_bar);

        document.querySelector('.button-container').style.visibility = 'hidden';
        console.log('Function Type:', function_type); // Debugging line
    });

    document.getElementById('btn-jiaohuqiangdu').addEventListener('click', function() {
        function_type = '交互强度';
        myecharts.setOption(option1, true); // 更新地图
        option_bar.xAxis[0].data = []; // Update the x-axis with top 10 city names
        option_bar.series[0].data = []; // Update the series with corresponding city values

        var myechart1 = echarts.init($('.users .bar')[0]);
        myechart1.setOption(option_bar);

        document.querySelector('.button-container').style.visibility = 'hidden';
        console.log('Function Type:', function_type); // Debugging line
    });

    document.getElementById('btn-jiaohurelitu').addEventListener('click', function() {
        function_type = '交互热力图';
         // 显示按钮容器
        option_bar.xAxis[0].data = []; // Update the x-axis with top 10 city names
        option_bar.series[0].data = []; // Update the series with corresponding city values

        var myechart1 = echarts.init($('.users .bar')[0]);
        myechart1.setOption(option_bar);
        // 显示按钮
        document.querySelector('.button-container').style.visibility = 'visible';
        document.querySelector('.map h3').innerHTML = `
        <span class="icon-cube"></span>
        医联体数量分布图
        `;
        // 修改标题内容
        document.querySelector('.users.panel h3').innerText = '各省医院数量柱状图（前10）';
        console.log('Function Type:', function_type); // Debugging line
        updateSelectedHospitals_jiaohu(); // Ensure the update function is called here
    });

    document.getElementById('btn-shuliangrelitu').addEventListener('click', function() {
        function_type = '数量热力图';
        document.querySelector('.button-container').style.visibility = 'hidden';
        // 修改地图标题
        document.querySelector('.map h3').innerHTML = `
        <span class="icon-cube"></span>
        医联体数量分布图
        `;
        // 修改标题内容
        document.querySelector('.users.panel h3').innerText = '各省医院数量柱状图（前10）';
        console.log('Function Type:', function_type); // Debugging line
        updateSelectedHospitals_shuliang(); // Ensure the update function is called here
    });



    // 下面是点击“沟通”“总数量“等改变
    document.getElementById('btn-total-intensity').addEventListener('click', function() {
        currentInteractionType = '文章数量'; // 设置为总强度
        if(function_type=='交互热力图')
        {
            updateSelectedHospitals_jiaohu(); // 更新图表   
        }
    });
    document.getElementById('btn-cooperation').addEventListener('click', function() {
        currentInteractionType = '合作'; // 设置为合作
        if(function_type=='交互热力图')
        {
            updateSelectedHospitals_jiaohu(); // 更新图表   
        }
    });

    document.getElementById('btn-communication').addEventListener('click', function() {
        currentInteractionType = '沟通'; // 设置为沟通
        if(function_type=='交互热力图')
        {
            updateSelectedHospitals_jiaohu(); // 更新图表   
        }
   });

    document.getElementById('btn-technology').addEventListener('click', function() {
        currentInteractionType = '技术'; // 设置为技术
        if(function_type=='交互热力图')
        {
            updateSelectedHospitals_jiaohu(); // 更新图表   
        }      
    });


}

// 监听复选框的状态变化
document.querySelectorAll('input[name="hospital"]').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
        if (function_type === '交互热力图') {
            updateSelectedHospitals_jiaohu();
        } else if (function_type === '数量热力图') {
            updateSelectedHospitals_shuliang();
        }
    });
});

// 设置按钮的监听事件
setupButtonListeners();


</script>
    



</html>